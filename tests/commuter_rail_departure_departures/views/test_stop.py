import pytest
import pytz
import datetime
from freezegun import freeze_time

from rest_framework.test import APIClient

from commuter_rail_departure_departures.models import Stop, Route
from commuter_rail_departure_departures.serializer.stop import StopSerializer


@pytest.mark.django_db
class TestStopReadOnlyViewset:

    url = "/departures/stop/"
    client = APIClient()

    def test_list_stops(self, create_stop_and_route):

        stops = Stop.stops.with_child_count().order_by("name")
        expected_res = StopSerializer(stops, many=True).data
        response = self.client.get(self.url)
        
        assert response.status_code == 200
        assert response.data == expected_res
    
    def test_retrieve_departure_arrival_data(self, mock_mbta_client, create_stop_and_route):
        expected_res_data = "{'departures': [{'carrier': 'MBTA', 'departure_time': '2024-02-06 07:00:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': '1638', 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 07:25:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': '1712', 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 07:30:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 07:35:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': '1724', 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 07:35:00-05:00', 'arrival_time': None, 'destination': 'Newburyport', 'vehicle_id': '1717', 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 07:47:00-05:00', 'arrival_time': None, 'destination': 'Rockport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 08:10:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 08:20:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 08:30:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 08:35:00-05:00', 'arrival_time': None, 'destination': 'Newburyport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 08:55:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 09:05:00-05:00', 'arrival_time': None, 'destination': 'Rockport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 09:10:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 09:30:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 09:35:00-05:00', 'arrival_time': None, 'destination': 'Beverly', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 09:40:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 10:05:00-05:00', 'arrival_time': None, 'destination': 'Newburyport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 10:10:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 10:25:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 10:30:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 10:35:00-05:00', 'arrival_time': None, 'destination': 'Rockport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 11:10:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 11:10:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 11:30:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 11:35:00-05:00', 'arrival_time': None, 'destination': 'Newburyport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 11:55:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 12:05:00-05:00', 'arrival_time': None, 'destination': 'Rockport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 12:10:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 12:30:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 12:40:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 13:05:00-05:00', 'arrival_time': None, 'destination': 'Newburyport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 13:10:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 13:25:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 13:30:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 13:35:00-05:00', 'arrival_time': None, 'destination': 'Rockport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 14:05:00-05:00', 'arrival_time': None, 'destination': 'Beverly', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 14:10:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 14:10:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 14:30:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 14:35:00-05:00', 'arrival_time': None, 'destination': 'Newburyport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 14:55:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 15:05:00-05:00', 'arrival_time': None, 'destination': 'Rockport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 15:10:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 15:35:00-05:00', 'arrival_time': None, 'destination': 'Newburyport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 15:40:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 15:40:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 15:55:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 16:05:00-05:00', 'arrival_time': None, 'destination': 'Rockport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 16:25:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 16:25:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 16:35:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 16:35:00-05:00', 'arrival_time': None, 'destination': 'Newburyport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 16:55:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 17:00:00-05:00', 'arrival_time': None, 'destination': 'Rockport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 17:05:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 17:10:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 17:30:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 17:35:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 17:35:00-05:00', 'arrival_time': None, 'destination': 'Newburyport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 17:42:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 17:55:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 18:05:00-05:00', 'arrival_time': None, 'destination': 'Rockport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 18:20:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 18:30:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 18:40:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 18:40:00-05:00', 'arrival_time': None, 'destination': 'Newburyport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 19:00:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 19:15:00-05:00', 'arrival_time': None, 'destination': 'Rockport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 19:30:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 19:30:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 19:45:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 20:05:00-05:00', 'arrival_time': None, 'destination': 'Newburyport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 20:45:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 20:50:00-05:00', 'arrival_time': None, 'destination': 'Rockport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 21:00:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 21:40:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 21:50:00-05:00', 'arrival_time': None, 'destination': 'Newburyport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 22:15:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 22:30:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 22:50:00-05:00', 'arrival_time': None, 'destination': 'Rockport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 23:40:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 23:45:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 23:50:00-05:00', 'arrival_time': None, 'destination': None, 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}, {'carrier': 'MBTA', 'departure_time': '2024-02-06 23:50:00-05:00', 'arrival_time': None, 'destination': 'Rockport', 'vehicle_id': None, 'status': 'ON-TIME', 'has_prediction': False}], 'eastern_time': '06:44:00 AM', 'eastern_date': '2024-02-06'}"
        stop = Stop.objects.get(mbta_id="place-north")
        moved_time = "2024-02-06 06:44:00"
        eastern = pytz.timezone('US/Eastern')
        moved_time_dt = eastern.localize(datetime.datetime.strptime(moved_time, "%Y-%m-%d %H:%M:%S"))
        with freeze_time(moved_time_dt) as freezer:
            res = self.client.get(f"{self.url}{stop.mbta_id}/")
        assert str(res.data) == expected_res_data
        
        
    def test_retrieve_stop_does_not_exist(self, mock_mbta_client):
        res = self.client.get(f"{self.url}invalid-mbta-id/")
        assert res.status_code == 404